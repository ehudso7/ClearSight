{
  "name": "ClearSight Ops - Daily Report Generator",
  "nodes": [
    {
      "name": "Cron Schedule",
      "type": "n8n-nodes-base.cron",
      "position": [250, 300],
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "hour": 6,
              "minute": 0
            }
          ]
        }
      }
    },
    {
      "name": "Get Active Clients",
      "type": "n8n-nodes-base.postgres",
      "position": [450, 300],
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT id, name, contact_email FROM clients WHERE active = true"
      }
    },
    {
      "name": "Split In Batches",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [650, 300],
      "parameters": {
        "batchSize": 1
      }
    },
    {
      "name": "Generate Report API",
      "type": "n8n-nodes-base.httpRequest",
      "position": [850, 300],
      "parameters": {
        "method": "POST",
        "url": "={{$env.API_BASE_URL}}/api/generate-daily-report",
        "jsonParameters": true,
        "bodyParametersJson": "={\"clientId\": \"={{$json.id}}\", \"date\": \"={{$now.format('YYYY-MM-DD')}}\"}"
      }
    },
    {
      "name": "Send Email",
      "type": "n8n-nodes-base.emailSend",
      "position": [1050, 300],
      "parameters": {
        "fromEmail": "no-reply@clearsightops.com",
        "toEmail": "={{$item(0).contact_email}}",
        "subject": "Daily Ops Report – ={{$now.format('MMM DD, YYYY')}}",
        "text": "={{$json.markdown}}",
        "options": {}
      }
    },
    {
      "name": "Slack Notification",
      "type": "n8n-nodes-base.slack",
      "position": [1050, 450],
      "parameters": {
        "webhookUrl": "={{$env.SLACK_WEBHOOK_URL}}",
        "text": "✅ Daily report sent to ={{$item(0).name}}"
      }
    }
  ],
  "connections": {
    "Cron Schedule": {
      "main": [[{ "node": "Get Active Clients", "type": "main", "index": 0 }]]
    },
    "Get Active Clients": {
      "main": [[{ "node": "Split In Batches", "type": "main", "index": 0 }]]
    },
    "Split In Batches": {
      "main": [[{ "node": "Generate Report API", "type": "main", "index": 0 }]]
    },
    "Generate Report API": {
      "main": [
        [
          { "node": "Send Email", "type": "main", "index": 0 },
          { "node": "Slack Notification", "type": "main", "index": 0 }
        ]
      ]
    }
  }
}
